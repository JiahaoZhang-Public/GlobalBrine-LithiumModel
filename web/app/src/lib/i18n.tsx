import { createContext, useContext, useEffect, useMemo, useState, type ReactNode } from "react";

export type Lang = "en" | "zh";

type Messages = Record<string, string>;

const messages: Record<Lang, Messages> = {
  en: {
    "nav.overview": "Overview",
    "nav.map": "Map Explorer",
    "nav.single": "Single Prediction",
    "nav.batch": "Batch Jobs",
    "nav.model": "Repro & Limits",
    "nav.team": "Team",
    "layout.tagline": "Predictive lithium selectivity for brine science",
    "layout.repo": "Code repo",
    "layout.methods": "Methods & limits",
    "layout.launch": "Launch explorer",
    "layout.footer.left": "GlobalBrine-LithiumModel • Research-grade web",
    "layout.footer.right": "Model version disclosed in-app • Reproducible by design",
    "landing.pill": "GlobalBrine • Scientist view",
    "landing.title": "Predict lithium selectivity from brine chemistry—interactive, reproducible, global.",
    "landing.desc": "Built for experimentalists: visualize global brine signals, submit site chemistry, and export reproducible predictions with units and applicability notes—no code required.",
    "landing.cta.map": "Open Map Explorer",
    "landing.cta.predict": "Single prediction",
    "landing.stat.global": "Global samples",
    "landing.stat.inputs": "Inputs",
    "landing.stat.turnaround": "Turnaround",
    "landing.stat.provenance": "Provenance",
    "landing.stat.helper.global": "Sites with modeled signals",
    "landing.stat.helper.inputs": "TDS, MLR, major ions",
    "landing.stat.helper.turnaround": "Single-point estimate",
    "landing.stat.helper.provenance": "Version + checksums",
    "landing.card1.title": "Global visualization",
    "landing.card1.desc": "Explore modeled selectivity, crystallization, and evaporation across all brine points with chemistry filters and hover details.",
    "landing.card2.title": "Instant inference",
    "landing.card2.desc": "Enter a single sample—partial inputs allowed—and see imputed chemistry plus predictions with units and quick interpretation.",
    "landing.card3.title": "Batch jobs",
    "landing.card3.desc": "Upload CSVs, run asynchronous jobs, and retrieve results with reproducible checksums, job identifiers, and schema guidance.",
    "landing.coverage.title": "Coverage snapshot",
    "landing.coverage.points": "points",
    "landing.coverage.min": "Min TDS",
    "landing.coverage.max": "Max selectivity",
    "datasets.heading": "Dataset downloads",
    "datasets.title": "Download datasets; preview when needed",
    "datasets.desc": "Grab raw chemistry and prediction-enriched CSVs. Rows stay hidden—expand to view the first 10 lines.",
    "datasets.version": "CSV files from the latest build (v0.2.2).",
    "datasets.raw.title": "Raw chemistry",
    "datasets.raw.desc": "Unprocessed brine chemistry observations for reproducing the model input distribution.",
    "datasets.pred.title": "Model predictions",
    "datasets.pred.desc": "Includes raw features, imputed features, and model outputs (selectivity, crystallization, evaporation).",
    "datasets.badge.raw": "CSV · chemistry only",
    "datasets.badge.pred": "CSV · with model outputs",
    "datasets.download": "Download CSV",
    "datasets.preview.show": "Show preview (first 10 rows)",
    "datasets.preview.hide": "Hide preview",
    "datasets.preview.error": "Preview unavailable.",
    "datasets.preview.loading": "Loading preview…",
    "map.title": "Global Map Explorer",
    "map.subtitle": "Visualize predicted selectivity, crystallization, and evaporation across all known brine sites.",
    "map.meta.points": "Points",
    "map.meta.selectivity": "Selectivity (max)",
    "map.meta.tds": "TDS range",
    "map.meta.mlr": "MLR range",
    "map.filters": "Filters",
    "map.units": "Units: TDS (g/L) • MLR (molar ratio)",
    "map.color.key": "Color key: selectivity (teal → magenta). Hover a point for exact values and units.",
    "map.color.by": "Color by",
    "map.option.selectivity": "Selectivity (unitless)",
    "map.option.crystallization": "Li crystallization (mg/m²·h)",
    "map.option.evap": "Evaporation (kg/m²·h)",
    "map.legend": "Teal → magenta shows low → high. Hover to see exact numbers and units.",
    "map.sample": "Sample",
    "single.title": "Single-Point Prediction",
    "single.subtitle": "Enter one brine sample. Missing fields can be imputed. Units: g/L for chemistry, kW/m² for light.",
    "single.impute": "Impute missing chemistry",
    "single.example": "Fill with example",
    "single.example.note": "Example reflects a mid-range salar sample; adjust values to your site.",
    "single.run": "Run prediction",
    "single.loading": "Running inference…",
    "single.error": "Prediction failed.",
    "single.empty": "Predictions will appear here.",
    "single.stat.selectivity": "Selectivity",
    "single.stat.helper": "Li⁺ vs Mg²⁺",
    "single.stat.crystallization": "Li crystallization",
    "single.stat.evap": "Evaporation",
    "single.imputed": "Imputed chemistry",
    "single.info": "Outputs are non-negative point estimates; uncertainty bands are not yet provided. See Repro & Limits for applicability notes.",
    "batch.title": "Batch Prediction Jobs",
    "batch.subtitle": "Upload a CSV with TDS_gL, MLR, Light_kW_m2 (g/L, unitless, kW/m²). Jobs run asynchronously and return a CSV with predictions.",
    "batch.sample": "Download sample CSV",
    "batch.choose": "Choose a CSV to upload",
    "batch.hint": "Up to ~200k rows. Required columns: TDS_gL, MLR, Light_kW_m2. Units must match.",
    "batch.impute": "Impute missing chemistry",
    "batch.start": "Start job",
    "batch.examples": "Example rows",
    "batch.copyhint": "Copy these values into your CSV to sanity-check formatting.",
    "batch.recipe": "Quick recipe",
    "batch.step1": "Create CSV header exactly: TDS_gL,MLR,Light_kW_m2.",
    "batch.step2": "Use g/L for TDS, unitless MLR, kW/m² for irradiance.",
    "batch.step3": "Missing values allowed; enable “Impute missing chemistry” if gaps exist.",
    "batch.step4": "Keep row count < 200k; larger jobs split into multiple uploads.",
    "batch.processing": "Processing…",
    "batch.failed": "Job failed.",
    "batch.download": "Download results",
    "batch.submitted": "Submitted at",
    "batch.note": "Outputs are point estimates; document unit assumptions in downstream analyses.",
    "model.title": "Reproducibility & Limits",
    "model.subtitle": "What the model expects, where it works best, and how to audit a run.",
    "model.version": "Model version",
    "model.tag": "Git tag",
    "model.commit": "Commit",
    "model.scalars": "Scalars & schema",
    "model.valid": "Valid range & units",
    "model.valid.desc": "Chemistry in grams per liter; irradiance in kW/m². Typical training domain: TDS 10–400 g/L, MLR 0–25, Light 0.05–1.0. Outside these ranges, interpret with caution.",
    "model.use": "Intended use",
    "model.use.desc": "For screening and ranking brine sites; not a substitute for lab crystallization tests. Partial inputs are allowed; missing chemistry may be imputed if enabled.",
    "model.limits": "Known limitations",
    "model.limit1": "Not calibrated for extreme salars (>450 g/L TDS) or geothermal fluids.",
    "model.limit2": "No uncertainty intervals yet; treat outputs as point estimates.",
    "model.limit3": "Batch jobs assume clean CSV/GeoJSON; validate units before upload.",
    "model.audit": "Audit trail (artifacts & checksums)",
    "model.artifacts": "Show artifact table",
    "model.checksums": "Checksums tie predictions to specific artifacts. Scaler path:",
    "team.title": "Team & Credits",
    "team.subtitle": "Contributors to the model, web platform, and global brine data collection.",
    "team.org": "Organization",
    "team.role.faculty": "Faculty mentor",
    "team.role.lead": "Implementation lead",
    "team.role.contact": "Group contact",
    "team.personalsite": "Personal site",
    "lang.toggle": "中文",
    "lang.toggle.zh": "EN",
  },
  zh: {
    "nav.overview": "总览",
    "nav.map": "地图探索",
    "nav.single": "单点预测",
    "nav.batch": "批量预测",
    "nav.model": "复现与局限",
    "nav.team": "团队",
    "layout.tagline": "面向卤水研究的锂选择性预测",
    "layout.repo": "代码仓库",
    "layout.methods": "方法与局限",
    "layout.launch": "打开地图",
    "layout.footer.left": "GlobalBrine-LithiumModel • 研究级 Web",
    "layout.footer.right": "版本透明 • 可复现",
    "landing.pill": "GlobalBrine • 科研视图",
    "landing.title": "基于卤水化学预测锂选择性——交互、可复现、全球覆盖。",
    "landing.desc": "为实验人员打造：可视化全球卤水信号，提交站点化学组成，导出附单位与适用性说明的可复现预测，无需编程。",
    "landing.cta.map": "打开地图探索",
    "landing.cta.predict": "单点预测",
    "landing.stat.global": "全球样点",
    "landing.stat.inputs": "输入",
    "landing.stat.turnaround": "响应时间",
    "landing.stat.provenance": "来源",
    "landing.stat.helper.global": "已建模站点数",
    "landing.stat.helper.inputs": "TDS、MLR、主要离子",
    "landing.stat.helper.turnaround": "单点推理",
    "landing.stat.helper.provenance": "版本与校验和",
    "landing.card1.title": "全球可视化",
    "landing.card1.desc": "按化学过滤并悬停查看详情，浏览选择性、结晶与蒸发预测。",
    "landing.card2.title": "即时推理",
    "landing.card2.desc": "输入单一样品（可缺失），查看插补化学与预测值及单位。",
    "landing.card3.title": "批量作业",
    "landing.card3.desc": "上传 CSV 异步运行，获取带校验和与作业编号的结果。",
    "landing.coverage.title": "覆盖快照",
    "landing.coverage.points": "个点",
    "landing.coverage.min": "最小 TDS",
    "landing.coverage.max": "最高选择性",
    "datasets.heading": "数据集下载",
    "datasets.title": "下载数据集，按需预览",
    "datasets.desc": "提供原始化学与含预测的 CSV，默认不展示行，展开可查看前 10 行。",
    "datasets.version": "CSV 取自最新构建（v0.2.2）。",
    "datasets.raw.title": "原始化学数据",
    "datasets.raw.desc": "未经过模型处理的卤水化学观测，可复现模型输入分布。",
    "datasets.pred.title": "模型预测数据",
    "datasets.pred.desc": "包含原始特征、插补特征及模型输出（选择性、结晶、蒸发）。",
    "datasets.badge.raw": "CSV · 仅化学",
    "datasets.badge.pred": "CSV · 含预测",
    "datasets.download": "下载 CSV",
    "datasets.preview.show": "展开预览（前 10 行）",
    "datasets.preview.hide": "收起预览",
    "datasets.preview.error": "预览不可用。",
    "datasets.preview.loading": "正在加载预览…",
    "map.title": "全球地图探索",
    "map.subtitle": "查看已知卤水站点的选择性、结晶与蒸发预测。",
    "map.meta.points": "样点数",
    "map.meta.selectivity": "选择性（最大）",
    "map.meta.tds": "TDS 范围",
    "map.meta.mlr": "MLR 范围",
    "map.filters": "筛选",
    "map.units": "单位：TDS g/L，MLR 摩尔比",
    "map.color.key": "颜色键：选择性（青 → 品红）。悬停查看具体数值与单位。",
    "map.color.by": "着色依据",
    "map.option.selectivity": "选择性（无量纲）",
    "map.option.crystallization": "锂结晶速率 (mg/m²·h)",
    "map.option.evap": "蒸发量 (kg/m²·h)",
    "map.legend": "青 → 品红表示数值从低到高，悬停可见具体数值与单位。",
    "map.sample": "样本",
    "single.title": "单点预测",
    "single.subtitle": "输入一个卤水样品，可选插补缺失项。单位：化学 g/L，光照 kW/m²。",
    "single.impute": "插补缺失化学",
    "single.example": "填入示例",
    "single.example.note": "示例代表中等浓度盐湖，可按站点调整。",
    "single.run": "运行预测",
    "single.loading": "正在推理…",
    "single.error": "预测失败。",
    "single.empty": "预测结果将显示在此。",
    "single.stat.selectivity": "选择性",
    "single.stat.helper": "Li⁺ 对 Mg²⁺",
    "single.stat.crystallization": "锂结晶速率",
    "single.stat.evap": "蒸发量",
    "single.imputed": "插补后的化学组成",
    "single.info": "输出为非负的点估计，暂未提供不确定性；适用性说明见“复现与局限”。",
    "batch.title": "批量预测作业",
    "batch.subtitle": "上传包含 TDS_gL、MLR、Light_kW_m2 的 CSV（单位：g/L、无量纲、kW/m²），异步返回带预测的 CSV。",
    "batch.sample": "下载示例 CSV",
    "batch.choose": "选择要上传的 CSV",
    "batch.hint": "最多约 20 万行，必需列：TDS_gL, MLR, Light_kW_m2，单位必须匹配。",
    "batch.impute": "插补缺失化学",
    "batch.start": "开始作业",
    "batch.examples": "示例行",
    "batch.copyhint": "可将这些数值复制到 CSV 以验证格式。",
    "batch.recipe": "快捷指引",
    "batch.step1": "CSV 头必须为：TDS_gL,MLR,Light_kW_m2。",
    "batch.step2": "TDS 用 g/L，MLR 无量纲，光照用 kW/m²。",
    "batch.step3": "允许缺失；如有缺口请勾选“插补缺失化学”。",
    "batch.step4": "行数 < 200k；更大作业请拆分上传。",
    "batch.processing": "处理中…",
    "batch.failed": "作业失败。",
    "batch.download": "下载结果",
    "batch.submitted": "提交时间",
    "batch.note": "输出为点估计；请在后续分析中注明单位假设。",
    "model.title": "复现与局限",
    "model.subtitle": "模型期望、适用范围及审计方法。",
    "model.version": "模型版本",
    "model.tag": "Git 标签",
    "model.commit": "提交",
    "model.scalars": "缩放与模式",
    "model.valid": "有效范围与单位",
    "model.valid.desc": "化学用 g/L，光照用 kW/m²。训练主域：TDS 10–400 g/L，MLR 0–25，光照 0.05–1.0；超出范围需谨慎解释。",
    "model.use": "预期用途",
    "model.use.desc": "用于卤水站点评估与排序；不能替代实验结晶测试。支持部分输入，缺失可插补。",
    "model.limits": "已知局限",
    "model.limit1": "未针对极端盐湖（>450 g/L TDS）或地热流体校准。",
    "model.limit2": "暂无不确定性区间；仅提供点估计。",
    "model.limit3": "批量作业假设 CSV/GeoJSON 干净；上传前请校验单位。",
    "model.audit": "审计轨迹（文件与校验和）",
    "model.artifacts": "展开文件表",
    "model.checksums": "校验和将预测绑定到特定文件。Scaler 路径：",
    "team.title": "团队与致谢",
    "team.subtitle": "模型、Web 平台与全球卤水数据采集的贡献者。",
    "team.org": "机构",
    "team.role.faculty": "导师",
    "team.role.lead": "实现负责人",
    "team.role.contact": "联系人",
    "team.personalsite": "个人主页",
    "lang.toggle": "EN",
    "lang.toggle.zh": "中文",
  },
};

type I18nContextValue = {
  lang: Lang;
  setLang: (lang: Lang) => void;
  t: (key: keyof typeof messages.en) => string;
};

const I18nContext = createContext<I18nContextValue | null>(null);

const STORAGE_KEY = "glb-lang";

export function I18nProvider({ children }: { children: ReactNode }) {
  const [lang, setLangState] = useState<Lang>(() => {
    const stored = localStorage.getItem(STORAGE_KEY) as Lang | null;
    if (stored === "en" || stored === "zh") return stored;
    const nav = navigator.language.toLowerCase();
    return nav.startsWith("zh") ? "zh" : "en";
  });

  useEffect(() => {
    localStorage.setItem(STORAGE_KEY, lang);
    document.documentElement.lang = lang;
  }, [lang]);

  const setLang = (l: Lang) => setLangState(l);

  const value = useMemo<I18nContextValue>(
    () => ({
      lang,
      setLang,
      t: (key) => messages[lang][key] ?? messages.en[key] ?? key,
    }),
    [lang]
  );

  return <I18nContext.Provider value={value}>{children}</I18nContext.Provider>;
}

export function useI18n() {
  const ctx = useContext(I18nContext);
  if (!ctx) throw new Error("useI18n must be used within I18nProvider");
  return ctx;
}
